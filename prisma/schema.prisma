generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "sqlite"
}

model Conversation {
  id         String    @id @default(cuid())
  title      String    @default("New Chat")
  model      String    @default("auto")
  ragEnabled   Boolean   @default(true)
  systemPrompt String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  messages     Message[]
}

model Message {
  id             String       @id @default(cuid())
  role           String       // "user" or "assistant"
  content        String
  model          String?      // which model handled this message (null for user messages)
  createdAt      DateTime     @default(now())
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  conversationId String

  @@index([conversationId])
}

model Document {
  id         String   @id @default(cuid())
  filename   String
  filepath   String?
  sourceUrl  String?
  sourceType String   // "markdown" | "text" | "pdf" | "code" | "url"
  mimeType   String?
  fileSize   Int?
  hash       String   // SHA-256 for dedup/change detection
  status     String   @default("pending") // "pending" | "processing" | "indexed" | "error"
  error      String?
  chunkCount Int      @default(0)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
  chunks     Chunk[]

  @@index([hash])
  @@index([status])
}

model Chunk {
  id         String   @id @default(cuid())
  documentId String
  content    String
  tokenCount Int
  chunkIndex Int
  metadata   String?  // JSON: { language, startLine, endLine, heading, etc. }
  createdAt  DateTime @default(now())
  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
}

model RagConfig {
  id                  String  @id @default("default")
  chunkSize           Int     @default(500)
  chunkOverlap        Int     @default(50)
  topK                Int     @default(5)
  similarityThreshold Float   @default(0.7)
  embeddingModel      String  @default("nomic-embed-text")
  ragEnabled          Boolean @default(true)
  watchedFolders      String  @default("[]")
  supportedTypes      String  @default("[\"md\",\"txt\",\"pdf\",\"ts\",\"js\",\"py\",\"go\",\"rs\",\"java\",\"cpp\",\"c\",\"html\",\"css\",\"json\",\"yaml\",\"toml\"]")
}

model AppConfig {
  id             String @id @default("singleton")
  defaultModel   String @default("")
  codeModel      String @default("")
  embeddingModel String @default("")
}
